{% extends "recruiting/base.html" %}

{% block title %}Applications — {{ offer.title }} - RH{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h2 mb-1">Applications</h1>
            <p class="text-muted">{{ offer.title }} @ {{ offer.company }}</p>
        </div>
        <a class="btn btn-outline-secondary" href="{% url 'recruiting:offer_list' %}">
            <i class="bi bi-arrow-left me-2"></i>Back to Offers
        </a>
    </div>

    <!-- Stats Cards -->
    <div class="row mb-4">
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-primary shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                Total Applications
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ applications|length }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="bi bi-people fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-success shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                New Applications
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="newApplications">
                                {{ applications|length }}  {# You can add logic to filter by status #}
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="bi bi-person-plus fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-warning shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                                Under Review
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="underReview">
                                {{ applications|length }}  {# You can add logic to filter by status #}
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="bi bi-clock-history fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-info shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                                Avg. Fit Score
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="avgFitScore">
                                {% with total_fit=applications|length %}
                                {% if total_fit > 0 %}
                                    {% with valid_fits=applications|dictsort:"predicted_fit" %}
                                    {{ valid_fits.0.predicted_fit|default:"—" }}
                                    {% endwith %}
                                {% else %}
                                    —
                                {% endif %}
                                {% endwith %}
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="bi bi-graph-up fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Applications List -->
    <div class="card shadow">
        <div class="card-header py-3 d-flex justify-content-between align-items-center">
            <h5 class="m-0 font-weight-bold text-primary">
                <i class="bi bi-person-lines-fill me-2"></i>Candidate Applications
            </h5>
            <span class="badge bg-primary fs-6">{{ applications|length }} applications</span>
        </div>
        <div class="card-body">
            {% if applications %}
                <div class="list-group">
                    {% for a in applications %}
                    <div class="list-group-item application-card mb-3 border-0 shadow-sm">
                        <div class="row align-items-center">
                            <!-- Candidate Info -->
                            <div class="col-md-4 mb-3 mb-md-0">
                                <div class="d-flex align-items-center">
                                    <div class="bg-primary rounded-circle d-flex align-items-center justify-content-center me-3" 
                                         style="width: 50px; height: 50px;">
                                        <i class="bi bi-person text-white"></i>
                                    </div>
                                    <div>
                                        <h6 class="mb-1 fw-bold">{{ a.user.username }}</h6>
                                        <div class="small text-muted">
                                            <i class="bi bi-envelope me-1"></i>{{ a.user.email|default:"No email" }}
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Status & Fit Score -->
                            <div class="col-md-3 mb-3 mb-md-0">
                                <div class="d-flex flex-column">
                                    <span class="badge {% if a.status == 'accepted' %}bg-success{% elif a.status == 'rejected' %}bg-danger{% else %}bg-warning{% endif %} mb-2 fit-badge">
                                        {{ a.get_status_display }}
                                    </span>
                                    <div class="small">
                                        <i class="bi bi-graph-up me-1"></i>
                                        Fit: 
                                        <span class="fw-bold {% if a.predicted_fit >= 80 %}text-success{% elif a.predicted_fit >= 60 %}text-warning{% else %}text-danger{% endif %}">
                                            {{ a.predicted_fit|default:"—" }}%
                                        </span>
                                    </div>
                                </div>
                            </div>

                            <!-- Status Update Form -->
                            <div class="col-md-3 mb-3 mb-md-0">
                                <form method="post" action="{% url 'recruiting:app_update_status' a.id %}" class="d-flex gap-2">
                                    {% csrf_token %}
                                    <select name="status" class="form-select form-select-sm" required>
                                        <option value="applied" {% if a.status == 'applied' %}selected{% endif %}>Applied</option>
                                        <option value="under_review" {% if a.status == 'under_review' %}selected{% endif %}>Under Review</option>
                                        <option value="interview" {% if a.status == 'interview' %}selected{% endif %}>Interview</option>
                                        <option value="accepted" {% if a.status == 'accepted' %}selected{% endif %}>Accepted</option>
                                        <option value="rejected" {% if a.status == 'rejected' %}selected{% endif %}>Rejected</option>
                                    </select>
                                    <button type="submit" class="btn btn-primary btn-sm">
                                        <i class="bi bi-check-lg"></i>
                                    </button>
                                </form>
                            </div>

                            <!-- Actions -->
                            <div class="col-md-2">
                                <div class="d-flex gap-2">
                                    <a class="btn btn-success btn-sm" href="{% url 'recruiting:feedback_create' a.id %}" title="Add Feedback">
                                        <i class="bi bi-chat-left-text"></i>
                                    </a>
                                    <button class="btn btn-outline-info btn-sm" type="button" data-bs-toggle="collapse" 
                                            data-bs-target="#feedback-{{ a.id }}" aria-expanded="false">
                                        <i class="bi bi-eye"></i>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Feedback Section -->
                        <div class="collapse mt-3" id="feedback-{{ a.id }}">
                            <div class="card card-body bg-light">
                                <h6 class="fw-bold mb-3">
                                    <i class="bi bi-chat-left-quote me-2"></i>Feedback History
                                </h6>
                                
                                {% if a.feedbacks.all %}
                                    <div class="list-group list-group-flush">
                                        {% for f in a.feedbacks.all %}
                                        <div class="list-group-item bg-transparent px-0">
                                            <div class="d-flex justify-content-between align-items-start mb-2">
                                                <span class="badge {% if f.feedback_type == 'positive' %}bg-success{% elif f.feedback_type == 'negative' %}bg-danger{% else %}bg-secondary{% endif %}">
                                                    {{ f.get_feedback_type_display }}
                                                </span>
                                                <small class="text-muted">{{ f.created_at|date:"M d, Y H:i" }}</small>
                                            </div>
                                            <p class="mb-0">{{ f.comment|default:"No additional comments provided." }}</p>
                                        </div>
                                        {% endfor %}
                                    </div>
                                {% else %}
                                    <div class="text-center py-3">
                                        <i class="bi bi-chat-left display-6 text-muted mb-3"></i>
                                        <p class="text-muted mb-0">No feedback provided yet.</p>
                                        <a class="btn btn-primary btn-sm mt-2" href="{% url 'recruiting:feedback_create' a.id %}">
                                            <i class="bi bi-plus-circle me-1"></i>Add First Feedback
                                        </a>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            {% else %}
                <!-- Empty State -->
                <div class="text-center py-5">
                    <div class="empty-icon mb-4">
                        <i class="bi bi-person-x display-1 text-muted"></i>
                    </div>
                    <h4 class="text-muted mb-3">No Applications Yet</h4>
                    <p class="text-muted mb-4">No candidates have applied to this offer yet.</p>
                    <a href="{% url 'recruiting:offer_list' %}" class="btn btn-primary">
                        <i class="bi bi-arrow-left me-2"></i>Back to Offers
                    </a>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<style>
    .application-card {
        transition: transform 0.2s, box-shadow 0.2s;
        border-radius: 10px;
        border: 1px solid #e3e6f0;
    }
    
    .application-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1) !important;
    }
    
    .fit-badge {
        font-size: 0.8rem;
        padding: 6px 12px;
        border-radius: 20px;
    }
    
    .border-left-primary {
        border-left: 4px solid #4e73df !important;
    }
    .border-left-success {
        border-left: 4px solid #1cc88a !important;
    }
    .border-left-warning {
        border-left: 4px solid #f6c23e !important;
    }
    .border-left-info {
        border-left: 4px solid #36b9cc !important;
    }
    
    .empty-icon {
        opacity: 0.7;
    }
    
    .list-group-item.bg-transparent {
        border: none;
        border-bottom: 1px solid rgba(0, 0, 0, 0.1);
    }
    
    .list-group-item.bg-transparent:last-child {
        border-bottom: none;
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Add smooth animations for collapsible sections
        const collapseButtons = document.querySelectorAll('[data-bs-toggle="collapse"]');
        collapseButtons.forEach(button => {
            button.addEventListener('click', function() {
                const target = document.querySelector(this.getAttribute('data-bs-target'));
                if (target) {
                    target.classList.toggle('show');
                }
            });
        });
        
        // Update stats based on actual data (you can enhance this with real calculations)
        updateApplicationStats();
    });
    
    function updateApplicationStats() {
        // You can implement real-time stats calculation here
        // For now, this is a placeholder for potential enhancements
        const applications = {{ applications|length }};
        
        // Example: Count applications by status
        const statusCounts = {
            applied: 0,
            under_review: 0,
            interview: 0,
            accepted: 0,
            rejected: 0
        };
        
        // You would iterate through applications and count by status
        // This is just a placeholder for the logic
        document.getElementById('newApplications').textContent = applications;
        document.getElementById('underReview').textContent = applications;
    }
</script>
{% endblock %}