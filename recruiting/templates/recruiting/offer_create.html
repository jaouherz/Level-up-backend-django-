{% extends 'recruiting/base.html' %}

{% block title %}Create Offer - RH{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h2 mb-1">Create New Offer</h1>
            <p class="text-muted">Fill in the details below to create a new job offer</p>
        </div>
        <a href="{% url 'recruiting:offer_list' %}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left me-2"></i>Back to Offers
        </a>
    </div>

    <!-- Form -->
    <div class="row justify-content-center">
        <div class="col-lg-14">
            <div class="card shadow">
                <div class="card-header bg-primary text-white py-3">
                    <h5 class="mb-0">
                        <i class="bi bi-plus-circle me-2"></i>New Job Offer Details
                    </h5>
                </div>
                <div class="card-body p-4">
                    <form id="offerForm">
                        <!-- Job Title -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <label for="title" class="form-label fw-semibold">
                                    <i class="bi bi-heading me-2 text-primary"></i>Job Title
                                </label>
                                <input type="text" class="form-control form-control-lg" id="title" 
                                       placeholder="e.g. Senior Frontend Developer, Data Scientist, Product Manager..." required>
                                <div class="form-text">Enter a clear and descriptive job title</div>
                            </div>
                        </div>

                        <!-- Job Description -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <label for="description" class="form-label fw-semibold">
                                    <i class="bi bi-file-text me-2 text-success"></i>Job Description
                                </label>
                                <textarea class="form-control" id="description" rows="6" 
                                          placeholder="Describe the role, responsibilities, requirements, and what makes this position exciting..." required></textarea>
                                <div class="form-text">Provide detailed information about the role and expectations</div>
                            </div>
                        </div>

                        <!-- Field and Level -->
                        <div class="row mb-4">
                            <div class="col-md-6 mb-3">
                                <label for="field_required" class="form-label fw-semibold">
                                    <i class="bi bi-mortarboard me-2 text-warning"></i>Field Required
                                </label>
                                <input type="text" class="form-control" id="field_required" 
                                       placeholder="e.g. Computer Science, Business, Engineering..." required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="level_required" class="form-label fw-semibold">
                                    <i class="bi bi-graph-up me-2 text-info"></i>Experience Level
                                </label>
                                <select class="form-select" id="level_required" required>
                                    <option value="">Select level...</option>
                                    <option value="intern">Internship</option>
                                    <option value="junior">Junior</option>
                                    <option value="mid">Mid-Level</option>
                                    <option value="senior">Senior</option>
                                    <option value="lead">Lead</option>
                                </select>
                            </div>
                        </div>

                        <!-- Required Skills -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <label class="form-label fw-semibold">
                                    <i class="bi bi-tools me-2 text-danger"></i>Required Skills
                                </label>
                                <select id="skillsSelect" class="form-select" multiple style="height: 140px;">
                                    <!-- Skills will be loaded here -->
                                </select>
                                <div class="form-text">
                                    <i class="bi bi-info-circle me-1"></i>Hold Ctrl/Cmd to select multiple skills
                                </div>
                            </div>
                        </div>

                        <!-- Add New Skill -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <label for="newSkill" class="form-label fw-semibold">
                                    <i class="bi bi-plus-circle me-2 text-success"></i>Add New Skill
                                </label>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="newSkill" 
                                           placeholder="Enter a new skill (e.g. React, Python, UX Design)...">
                                    <button type="button" class="btn btn-primary" id="addSkillBtn">
                                        <i class="bi bi-plus me-1"></i>Add Skill
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Selected Skills Display -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <label class="form-label fw-semibold">Selected Skills</label>
                                <div id="selectedSkills" class="d-flex flex-wrap gap-2 p-3 bg-light rounded">
                                    <span class="text-muted">No skills selected yet</span>
                                </div>
                            </div>
                        </div>

                        <!-- Submit Button -->
                        <div class="row mt-4">
                            <div class="col-12">
                                <button type="submit" class="btn btn-primary btn-lg w-100 py-3" id="submitBtn">
                                    <i class="bi bi-rocket-takeoff me-2"></i>Create Job Offer
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .skill-tag {
        background: linear-gradient(135deg, #4e73df, #224abe);
        color: white;
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 0.9rem;
        font-weight: 500;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    
    .skill-tag .remove {
        cursor: pointer;
        opacity: 0.8;
        transition: all 0.3s ease;
        width: 18px;
        height: 18px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.2);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.8rem;
        font-weight: bold;
    }
    
    .skill-tag .remove:hover {
        opacity: 1;
        background: rgba(255, 255, 255, 0.3);
        transform: scale(1.1);
    }
    
    .form-control, .form-select {
        border: 2px solid #e3e6f0;
        transition: all 0.3s ease;
    }
    
    .form-control:focus, .form-select:focus {
        border-color: #4e73df;
        box-shadow: 0 0 0 0.2rem rgba(78, 115, 223, 0.25);
    }
    
    .form-control-lg {
        font-size: 1.1rem;
        padding: 12px 16px;
    }
    
    .card {
        border: none;
        border-radius: 10px;
    }
    
    .card-header {
        border-radius: 10px 10px 0 0 !important;
    }
    
    @keyframes shake {
        0%, 100% { transform: translateX(0); }
        25% { transform: translateX(-5px); }
        75% { transform: translateX(5px); }
    }
    
    .shake {
        animation: shake 0.5s ease-in-out;
    }
    
    .btn-loading {
        position: relative;
        color: transparent !important;
    }
    
    .btn-loading::after {
        content: '';
        position: absolute;
        width: 20px;
        height: 20px;
        top: 50%;
        left: 50%;
        margin-left: -10px;
        margin-top: -10px;
        border: 2px solid transparent;
        border-top-color: white;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    loadSkills();

    // Initialize event listeners
    document.getElementById("skillsSelect").addEventListener("change", updateSelectedSkills);
    document.getElementById("addSkillBtn").addEventListener("click", addNewSkill);
    document.getElementById("offerForm").addEventListener("submit", submitOfferForm);
});

let allSkills = [];
const access = localStorage.getItem("access");

async function loadSkills() {
    try {
        const res = await fetch("/api/skills/", {
            headers: { "Authorization": "Bearer " + access }
        });
        const skills = await res.json();

        // Assign API response to allSkills
        allSkills = skills;

        const select = document.getElementById("skillsSelect");
        select.innerHTML = "";

        allSkills.forEach(skill => {
            select.innerHTML += `<option value="${skill.name}">${skill.name}</option>`;
        });

    } catch (error) {
        console.error('Error loading skills:', error);
        alert('Error loading skills. Please refresh the page.');
    }
}

function updateSelectedSkills() {
    const selected = Array.from(document.getElementById("skillsSelect").selectedOptions);
    const container = document.getElementById("selectedSkills");

    if (selected.length === 0) {
        container.innerHTML = '<span class="text-muted">No skills selected yet</span>';
        return;
    }

    container.innerHTML = selected.map(opt => `
        <span class="skill-tag">
            ${opt.value}
            <span class="remove" onclick="deselectSkill('${opt.value}')">Ã—</span>
        </span>
    `).join('');
}

function deselectSkill(skillName) {
    const select = document.getElementById("skillsSelect");
    const option = Array.from(select.options).find(opt => opt.value === skillName);
    if (option) option.selected = false;
    updateSelectedSkills();
}

async function addNewSkill() {
    const newSkillInput = document.getElementById("newSkill");
    const newSkill = newSkillInput.value.trim();

    if (!newSkill) {
        newSkillInput.classList.add('shake');
        setTimeout(() => newSkillInput.classList.remove('shake'), 500);
        return alert("Please enter a skill name.");
    }

    if (allSkills.some(skill => skill.name.toLowerCase() === newSkill.toLowerCase())) {
        newSkillInput.classList.add('shake');
        setTimeout(() => newSkillInput.classList.remove('shake'), 500);
        return alert("This skill already exists in the list!");
    }

    const addBtn = document.getElementById("addSkillBtn");
    const originalText = addBtn.innerHTML;
    addBtn.innerHTML = '<i class="bi bi-arrow-repeat spinner-border spinner-border-sm me-1"></i>Adding...';
    addBtn.disabled = true;

    try {
        const res = await fetch("/api/skills/", {
            method: "POST",
            headers: {
                "Authorization": "Bearer " + access,
                "Content-Type": "application/json"
            },
            body: JSON.stringify({ name: newSkill })
        });
        const addedSkill = await res.json(); // should return {id: ..., name: ...}

        // Add to local skills array
        allSkills.push(addedSkill);

        // Update skills select
        const select = document.getElementById("skillsSelect");
        const newOption = new Option(addedSkill.name, addedSkill.name);
        select.add(newOption);

        // Select the new skill
        newOption.selected = true;
        updateSelectedSkills();

        // Clear input
        newSkillInput.value = "";

        addBtn.innerHTML = '<i class="bi bi-check me-1"></i>Added!';
        setTimeout(() => {
            addBtn.innerHTML = '<i class="bi bi-plus me-1"></i>Add Skill';
            addBtn.disabled = false;
        }, 1000);

    } catch (error) {
        alert("Error adding skill. Please try again.");
        addBtn.innerHTML = originalText;
        addBtn.disabled = false;
    }
}

async function submitOfferForm(e) {
    e.preventDefault();

    const selectedSkills = Array.from(document.getElementById("skillsSelect").selectedOptions)
                                .map(opt => opt.value);

    const body = {
        title: document.getElementById("title").value,
        description: document.getElementById("description").value,
        field_required: document.getElementById("field_required").value,
        level_required: document.getElementById("level_required").value,
        required_skills: selectedSkills
    };

    const submitBtn = document.getElementById("submitBtn");
    submitBtn.classList.add('btn-loading');
    submitBtn.disabled = true;

    try {
        await fetch("/api/offers/", {
            method: "POST",
            headers: {
                "Authorization": "Bearer " + access,
                "Content-Type": "application/json"
            },
            body: JSON.stringify(body)
        });

        await new Promise(resolve => setTimeout(resolve, 2000));
        submitBtn.classList.remove('btn-loading');
        submitBtn.innerHTML = '<i class="bi bi-check me-2"></i>Offer Created Successfully!';
        submitBtn.classList.remove('btn-primary');
        submitBtn.classList.add('btn-success');

        setTimeout(() => {
            window.location.href = "{% url 'recruiting:offer_list' %}";
        }, 1500);

    } catch (error) {
        alert("Error creating offer: " + error.message);
        submitBtn.classList.remove('btn-loading');
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="bi bi-rocket-takeoff me-2"></i>Create Job Offer';
    }
}
</script>

{% endblock %}