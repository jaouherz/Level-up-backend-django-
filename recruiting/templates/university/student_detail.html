{% extends 'recruiting/base.html' %}

{% block title %}Student Profile - RH{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Page Header -->
    <div class="page-header">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1 class="h2 mb-1">Student Profile</h1>
                <p class="text-muted">View detailed information about the student and their internship progress</p>
            </div>
            <div>
                <button class="btn btn-outline-secondary" onclick="window.history.back()">
                    <i class="bi bi-arrow-left me-1"></i>Back
                </button>
            </div>
        </div>
    </div>

    <!-- Student Information -->
    <div class="row mb-4">
        <div class="col-lg-4 mb-4">
            <div class="card shadow h-100">
                <div class="card-header bg-primary text-white">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-person-circle me-2"></i>Student Information
                    </h5>
                </div>
                <div class="card-body">
                    <div class="text-center mb-4">
                        <div class="student-avatar mx-auto mb-3">
                            <i class="bi bi-person-circle"></i>
                        </div>
                        <h4 id="studentName">Student</h4>
                        <p class="text-muted" id="studentEmail">Loading...</p>
                        <span class="badge student-id-badge" id="studentIdBadge">ID: Loading...</span>
                    </div>
                    
                    <div class="student-info">
                        <div class="info-item mb-3">
                            <small class="text-muted d-block">Field of Study</small>
                            <div class="d-flex align-items-center">
                                <i class="bi bi-book me-2 text-primary"></i>
                                <span id="studentField">Loading...</span>
                            </div>
                        </div>
                        
                        <div class="info-item mb-3">
                            <small class="text-muted d-block">GPA Score</small>
                            <div class="d-flex align-items-center">
                                <i class="bi bi-graph-up me-2 text-success"></i>
                                <span id="studentGPA">Loading...</span>
                            </div>
                        </div>
                        
                        <div class="info-item mb-3">
                            <small class="text-muted d-block">Overall Score</small>
                            <div class="d-flex align-items-center">
                                <i class="bi bi-star me-2 text-warning"></i>
                                <span id="studentScore">Loading...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Internship Demands Status -->
        <div class="col-lg-8 mb-4">
            <div class="card shadow h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-clipboard-check me-2"></i>Internship Demands History
                    </h5>
                    <span class="badge bg-primary" id="demandsCount">0</span>
                </div>
                <div class="card-body">
                    <div id="demandsContainer">
                        <div class="text-center py-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2 text-muted">Loading demands information...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Accepted Applications -->
    <div class="row">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-briefcase me-2"></i>Accepted Internship Applications
                    </h5>
                    <span class="badge bg-primary" id="acceptedCount">0</span>
                </div>
                <div class="card-body">
                    <div id="acceptedApplications">
                        <div class="text-center py-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2 text-muted">Loading applications...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .card-body{
        overflow: auto;
        flex: 1 1 auto;
        padding: var(--bs-card-spacer-y) var(--bs-card-spacer-x);
        color: var(--bs-card-color);
        max-height: 510px;
    }
    .page-header {
        padding: 1rem 0;
        border-bottom: 1px solid #e9ecef;
        margin-bottom: 2rem;
    }
    
    .card {
        border: none;
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
    }
    
    .student-avatar {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        background: linear-gradient(135deg, #4e73df, #224abe);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 2rem;
    }
    
    .info-item {
        padding: 0.75rem;
        border-radius: 8px;
        background: #f8f9fa;
    }
    
    .application-card {
        border-left: 4px solid #4e73df;
        transition: transform 0.2s;
    }
    
    .application-card:hover {
        transform: translateY(-2px);
    }
    
    .demand-card {
        border-left: 4px solid;
        transition: transform 0.2s;
        margin-bottom: 1rem;
    }
    
    .demand-card:hover {
        transform: translateY(-1px);
    }
    
    .demand-pending {
        border-left-color: #f6c23e;
    }
    
    .demand-approved {
        border-left-color: #1cc88a;
    }
    
    .demand-rejected {
        border-left-color: #e74a3b;
    }
    
    .fit-badge {
        font-size: 0.8rem;
        padding: 0.35rem 0.75rem;
    }
    
    .status-badge {
        font-size: 0.8rem;
        padding: 0.35rem 0.75rem;
    }
    
    .empty-state {
        text-align: center;
        padding: 3rem;
        color: #6c757d;
    }
    
    .empty-state i {
        font-size: 3rem;
        margin-bottom: 1rem;
        color: #dee2e6;
    }
    
    .student-id-badge {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        font-weight: 600;
        font-size: 0.75rem;
        padding: 0.4rem 0.8rem;
        border-radius: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .demand-header {
        display: flex;
        justify-content: between;
        align-items: flex-start;
        margin-bottom: 1rem;
    }
    
    .demand-info {
        flex: 1;
    }
</style>

<script>
    const token = localStorage.getItem("access");

    // Extract student_id from URL
    const studentId = window.location.pathname.split("/").slice(-2)[0];

    async function loadDetails() {
        try {
            const res = await fetch(`/api/internship-demands/student/${studentId}/details/`, {
                headers: { "Authorization": "Bearer " + token }
            });

            if (!res.ok) {
                throw new Error('Failed to load student details');
            }

            const data = await res.json();
            console.log("Student details data:", data);

            // Update student information
            updateStudentInfo(data.student);
            
            // Update internship demands
            updateDemands(data.internship_demands);
            
            // Update accepted applications
            updateApplications(data.accepted_applications);

        } catch (error) {
            console.error("Error loading student details:", error);
            document.getElementById("demandsContainer").innerHTML = `
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    Failed to load student details. Please try again.
                </div>
            `;
        }
    }

    function updateStudentInfo(student) {
        // Update basic student info
        document.getElementById('studentEmail').textContent = student.email;
        document.getElementById('studentField').textContent = student.field_of_study || 'Not specified';
        document.getElementById('studentGPA').textContent = student.gpa || 'Not available';
        document.getElementById('studentScore').textContent = student.score || 'Not available';
        document.getElementById('studentIdBadge').textContent = `ID: ${student.id}`;
        
        // Try to get student name from email as fallback
        const emailName = student.email.split('@')[0];
        const formattedName = emailName.split('.').map(part => 
            part.charAt(0).toUpperCase() + part.slice(1)
        ).join(' ');
        document.getElementById('studentName').textContent = formattedName;
    }

    function updateDemands(demands) {
        const container = document.getElementById('demandsContainer');
        const countElement = document.getElementById('demandsCount');
        
        countElement.textContent = demands ? demands.length : 0;

        if (!demands || demands.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <i class="bi bi-clipboard-x"></i>
                    <h5>No Demands Submitted</h5>
                    <p class="text-muted">This student hasn't submitted any internship demands yet.</p>
                </div>
            `;
            return;
        }

        // Sort demands by created date (newest first)
        const sortedDemands = demands.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

        let demandsHTML = '';
        
        sortedDemands.forEach(demand => {
            const statusClass = `demand-${demand.status}`;
            const statusBadge = getStatusBadge(demand.status);
            
            demandsHTML += `
                <div class="card demand-card ${statusClass}">
                    <div class="card-body">
                        <div class="demand-header">
                            <div class="demand-info">
                                <h6 class="card-title mb-1">Demand #${demand.id}</h6>
                                <p class="text-muted small mb-2">
                                    <i class="bi bi-calendar me-1"></i>
                                    Submitted: ${formatDate(demand.created_at)}
                                </p>
                            </div>
                            ${statusBadge}
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="info-item">
                                    <small class="text-muted d-block">Status</small>
                                    <div class="d-flex align-items-center">
                                        <i class="bi bi-${getStatusIcon(demand.status)} me-2 text-${getStatusColor(demand.status)}"></i>
                                        <span class="text-capitalize">${demand.status}</span>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="info-item">
                                    <small class="text-muted d-block">Review Date</small>
                                    <div class="d-flex align-items-center">
                                        <i class="bi bi-calendar-check me-2 ${demand.reviewed_at ? 'text-success' : 'text-muted'}"></i>
                                        <span>${demand.reviewed_at ? formatDate(demand.reviewed_at) : 'Not reviewed yet'}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        });
        
        container.innerHTML = demandsHTML;
    }

    function updateApplications(applications) {
        const container = document.getElementById('acceptedApplications');
        const countElement = document.getElementById('acceptedCount');
        
        countElement.textContent = applications.length;

        if (applications.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <i class="bi bi-briefcase"></i>
                    <h5>No Accepted Applications</h5>
                    <p class="text-muted">This student hasn't been accepted for any internships yet.</p>
                </div>
            `;
            return;
        }

        let applicationsHTML = '<div class="row">';
        
        applications.forEach(app => {
            const fitBadge = getFitBadge(app.predicted_fit);
            
            applicationsHTML += `
                <div class="col-lg-6 mb-4">
                    <div class="card application-card h-100">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start mb-3">
                                <h6 class="card-title">${app.offer_title}</h6>
                                ${fitBadge}
                            </div>
                            
                            <div class="application-details">
                                <div class="info-item mb-2">
                                    <small class="text-muted d-block">Company</small>
                                    <div class="d-flex align-items-center">
                                        <i class="bi bi-building me-2 text-primary"></i>
                                        <span>${app.company}</span>
                                    </div>
                                </div>
                                
                                <div class="info-item mb-2">
                                    <small class="text-muted d-block">Required Field</small>
                                    <div class="d-flex align-items-center">
                                        <i class="bi bi-book me-2 text-info"></i>
                                        <span>${app.field_required}</span>
                                    </div>
                                </div>
                                
                                <div class="info-item mb-2">
                                    <small class="text-muted d-block">Level Required</small>
                                    <div class="d-flex align-items-center">
                                        <i class="bi bi-graph-up me-2 text-success"></i>
                                        <span class="text-capitalize">${app.level_required}</span>
                                    </div>
                                </div>
                                
                                <div class="info-item mb-2">
                                    <small class="text-muted d-block">Application ID</small>
                                    <div class="d-flex align-items-center">
                                        <i class="bi bi-hash me-2 text-secondary"></i>
                                        <span>${app.id}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        });
        
        applicationsHTML += '</div>';
        container.innerHTML = applicationsHTML;
    }

    function getStatusBadge(status) {
        const badges = {
            pending: '<span class="badge bg-warning status-badge"><i class="bi bi-clock me-1"></i>Pending</span>',
            approved: '<span class="badge bg-success status-badge"><i class="bi bi-check-lg me-1"></i>Approved</span>',
            rejected: '<span class="badge bg-danger status-badge"><i class="bi bi-x-lg me-1"></i>Rejected</span>'
        };
        return badges[status] || '<span class="badge bg-secondary status-badge">Unknown</span>';
    }

    function getStatusIcon(status) {
        const icons = {
            pending: 'clock',
            approved: 'check-circle',
            rejected: 'x-circle'
        };
        return icons[status] || 'question-circle';
    }

    function getStatusColor(status) {
        const colors = {
            pending: 'warning',
            approved: 'success',
            rejected: 'danger'
        };
        return colors[status] || 'secondary';
    }

    function getFitBadge(fitScore) {
        if (!fitScore && fitScore !== 0) return '<span class="badge bg-secondary fit-badge">No score</span>';
        
        const score = parseFloat(fitScore);
        if (score >= 0.8) {
            return `<span class="badge bg-success fit-badge">Excellent Fit (${(score * 100).toFixed(0)}%)</span>`;
        } else if (score >= 0.6) {
            return `<span class="badge bg-info fit-badge">Good Fit (${(score * 100).toFixed(0)}%)</span>`;
        } else if (score >= 0.4) {
            return `<span class="badge bg-warning fit-badge">Moderate Fit (${(score * 100).toFixed(0)}%)</span>`;
        } else {
            return `<span class="badge bg-danger fit-badge">Low Fit (${(score * 100).toFixed(0)}%)</span>`;
        }
    }

    function formatDate(dateString) {
        if (!dateString) return 'Not available';
        try {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        } catch (error) {
            return 'Invalid date';
        }
    }

    // Load details on page load
    document.addEventListener("DOMContentLoaded", loadDetails);
</script>
{% endblock %}